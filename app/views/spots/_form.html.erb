<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
  <% if spot.errors.any? %>
    <div class="mb-4 rounded-lg bg-red-50 border border-red-200 p-3 text-sm text-red-700">
      <p class="font-semibold mb-1">
        入力内容にエラーがあります。
      </p>
      <ul class="list-disc list-inside">
        <% spot.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: spot, local: true, class: "space-y-5", data: { controller: "spot-metadata" } do |f| %>
    <!-- URL -->
    <div>
      <div class="flex items-center justify-between mb-1">
        <%= f.label :url, "スポットのURL", class: "block text-sm font-medium text-gray-700" %>
        <span class="text-xs text-emerald-500">必須</span>
      </div>
      <%= f.url_field :url,
            placeholder: "例）https://example.com/nice-spot",
            class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm
                    shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
            data: {
              spot_metadata_target: "url",
              action: "input->spot-metadata#fetchMetadata"
            } %>
    </div>

    <!-- タイトル -->
    <div>
      <div class="flex items-center justify-between mb-1">
        <%= f.label :title, "タイトル", class: "block text-sm font-medium text-gray-700" %>
        <span class="text-xs text-emerald-500">必須</span>
      </div>
      <%= f.text_field :title,
            placeholder: "例）雰囲気最高の夜景バー",
            class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm
                    shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
            data: { spot_metadata_target: "title" } %>
    </div>

      <!-- メモ（description） -->
      <div>
        <%= f.label :description,
              "メモ（引用や気になるポイントなど）",
              class: "block text-sm font-medium text-gray-700 mb-1" %>

        <!-- 外枠（白） -->
        <div class="rounded-lg border border-slate-300 bg-white">
          <!-- スクロール可能エリア（グレー） -->
          <div class="max-h-40 sm:max-h-52 overflow-y-auto bg-slate-50 rounded-lg p-2">
            <%= f.text_area :description,
                  rows: 3,
                  placeholder: "気になった理由や、サイトからの引用メモなどを書いておきましょう。",
                  class: "w-full bg-transparent border-none focus:outline-none text-sm resize-none",
                  data: { spot_metadata_target: "description" } %>
          </div>
        </div>
      </div>

    <!-- ひとことメモ -->
    <div>
      <%= f.label :memo, "ひとことメモ（相手に伝えたいこと）",
            class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_field :memo,
            placeholder: "例）記念日に使いたい / 個室あり / 雨の日でもOK など",
            class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm
                    shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" %>
    </div>

    <!-- 画像URL（任意） -->
    <div>
      <%= f.label :image_url, "画像URL（任意）",
            class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.url_field :image_url,
            placeholder: "サムネイル用の画像URLがあれば入力",
            class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm
                    shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
            data: {
              spot_metadata_target: "imageUrl",
              action: "input->spot-metadata#updateImagePreview"
            } %>

      <div
        data-spot-metadata-target="imagePreviewWrapper"
        class="mt-3 <%= 'hidden' if spot.image_url.blank? %>">
        <%= image_tag(spot.image_url.presence || "",
              class: "w-full max-h-48 object-cover rounded-lg border border-slate-200",
              data: { spot_metadata_target: "imagePreview" }) %>
      </div>
    </div>

    <!-- 行き先リスト選択 -->
    <div class="pt-3 border-t border-slate-100">
      <p class="text-xs font-medium text-gray-700 mb-1">
        どの「行き先リスト」に入れる？
      </p>

      <% if current_user.lists.any? %>
        <div class="max-h-40 sm:max-h-52 overflow-y-auto pr-1
                    bg-slate-50 rounded-lg p-2 border border-slate-200">
          <div class="flex flex-wrap gap-2">
            <%= f.collection_check_boxes :list_ids, current_user.lists, :id, :name do |b| %>
              <label class="inline-flex items-center gap-1 px-3 py-1 rounded-full
                            border border-slate-300 bg-white text-xs text-gray-700
                            hover:border-emerald-300 hover:bg-emerald-50 cursor-pointer">
                <%= b.check_box class: "rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" %>
                <span class="truncate max-w-[140px]"><%= b.text %></span>
              </label>
            <% end %>
          </div>
        </div>
      <% else %>
        <p class="text-xs text-gray-500">
          まだ行き先リストがありません。<br>
          先に <%= link_to "リストを作成", new_list_path,
                  class: "text-emerald-600 underline decoration-emerald-300" %> してから、
          スポットを登録しましょう。
        </p>
      <% end %>
    </div>

    <!-- タグ入力(tagging) タグチップにして(x)削除可能に-->
    <div
      data-controller="tag-input" data-tag-input-initial-tags-value="<%= spot.tag_names %>"
    >
      <p class="text-xs font-medium text-gray-700 mb-1">
        タグをつけておくと、あとで見返しやすくなります。<br>
        <span class="text-[11px] text-gray-500">
          スペース / 、 / カンマで区切って複数入力できます。<br>
          Enterでタグを追加します。
        </span>
      </p>

      <!-- チップを並べるエリア => (× デート) みたいなタグがここに生える-->
      <div class="flex flex-wrap gap-2 mb-2" data-tag-input-target="chips">
      </div>

      <!-- 追加用インプット -->
      <input
        type="text"
        placeholder="例）デート 夜景 個室あり"
        class="w-full rounded-lg border border-dashed border-slate-300 bg-slate-50 px-3 py-2 text-xs text-gray-700
               focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
        data-tag-input-target="input"
        data-action="keydown->tag-input#handleKeydown blur->tag-input#commitInput"
      >

      <!-- 実際に送信する hidden フィールド -->
      <%= hidden_field_tag "spot[tag_names]",
            spot.tag_names,
            data: { tag_input_target: "hidden" } %>
    </div>

    <!-- ボタン -->
    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
      <% cancel_path =
            if request.referer.present?
               request.referer
            else
              # 直前URLが取れないレアケース用の保険
              spot.persisted? ? spot_path(spot) : spots_path
            end %>

      <%= link_to "キャンセル",
                  cancel_path,
                  class: "text-xs sm:text-sm text-gray-500 hover:text-gray-700" %>

      <div class="flex gap-2">
        <%= f.submit "保存する",
              class: "inline-flex items-center px-4 py-2 rounded-lg text-xs sm:text-sm
                      bg-emerald-500 text-white font-medium hover:bg-emerald-600
                      disabled:opacity-60 disabled:cursor-not-allowed" %>
      </div>
    </div>
  <% end %>
</div>
