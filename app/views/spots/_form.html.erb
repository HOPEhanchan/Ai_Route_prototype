<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
  <% if spot.errors.any? %>
    <div class="mb-4 rounded-lg bg-red-50 border border-red-200 p-3 text-sm text-red-700">
      <p class="font-semibold mb-1">
        入力内容にエラーがあります。
      </p>
      <ul class="list-disc list-inside">
        <% spot.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: spot,
                local: true,
                class: "space-y-5",
                data: { controller: "spot-metadata" } do |f| %>

    <!-- URL -->
    <div>
      <div class="flex items-center justify-between mb-1">
        <%= f.label :url, "スポットのURL", class: "block text-sm font-medium text-gray-700" %>
        <span class="text-xs text-emerald-500">必須</span>
      </div>

      <div class="relative w-full overflow-hidden">
        <%= f.url_field :url,
              placeholder: "例）https://example.com/nice-spot",
              class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-12 text-sm
                      shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
              data: {
                spot_metadata_target: "url",
                action: "paste->spot-metadata#handlePaste blur->spot-metadata#fetchMetadata"
              } %>

        <!-- URL のクリアボタン -->
        <button
          type="button"
          data-action="click->spot-metadata#clearUrlField"
          class="absolute inset-y-0 right-0 my-auto
                 w-6 h-6
                 rounded-full bg-slate-200/90 backdrop-blur
                 text-slate-700 hover:bg-slate-400
                 text-[12px] leading-none font-bold transition"
        >
          ×
        </button>
      </div>
    </div>

    <!-- タイトル -->
    <div>
      <div class="flex items-center justify-between mb-1">
        <%= f.label :title, "タイトル", class: "block text-sm font-medium text-gray-700" %>
        <span class="text-xs text-emerald-500">必須</span>
      </div>

      <div class="relative w-full overflow-hidden">
        <%= f.text_field :title,
              placeholder: "例）雰囲気最高の夜景バー",
              class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-12 text-sm
                      shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
              data: {
                spot_metadata_target: "title"
              } %>

        <!-- タイトル のクリアボタン -->
        <button
          type="button"
          data-action="click->spot-metadata#clearTitleField"
          class="absolute right-0 top-1/2 -translate-y-1/2
                 w-6 h-6
                 rounded-full bg-slate-200/90 backdrop-blur
                 text-slate-700 hover:bg-slate-400
                 text-[12px] leading-none font-bold transition"
        >
          ×
        </button>
      </div>
    </div>

    <!-- メモ（description） -->
    <div>
      <%= f.label :description,
            "メモ（引用や気になるポイントなど）",
            class: "block text-sm font-medium text-gray-700 mb-1" %>

      <div class="relative w-full overflow-hidden">
        <!-- 外枠（白） -->
        <div class="rounded-lg border border-slate-300 bg-white">
          <!-- スクロール可能エリア（グレー） -->
          <div class="max-h-40 sm:max-h-52 overflow-y-auto bg-slate-50 rounded-lg p-2">
            <%= f.text_area :description,
                  rows: 3,
                  placeholder: "気になった理由や、サイトからの引用メモなどを書いておきましょう。",
                  class: "w-full bg-transparent border-none focus:outline-none text-sm resize-none",
                  data: {
                    spot_metadata_target: "description"
                  } %>

            <!-- メモ のクリアボタン -->
            <button
              type="button"
              class="mt-2 inline-flex items-center px-3 py-1 rounded-md text-[11px]
                     border border-slate-300 bg-white text-slate-600 hover:bg-slate-100"
              data-action="click->spot-metadata#clearDescriptionField"
            >
              メモをクリア
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ひとことメモ -->
    <div>
      <%= f.label :memo, "ひとことメモ（相手に伝えたいこと）",
            class: "block text-sm font-medium text-gray-700 mb-1" %>

      <div class="relative w-full overflow-hidden">
        <%= f.text_field :memo,
              placeholder: "例）記念日に使いたい / 個室あり / 雨の日でもOK など",
              class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-12 text-sm
                      shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
              data: {
                spot_metadata_target: "memo"
              } %>
        <!-- ひとことメモ のクリアボタン -->
        <button
          type="button"
          data-action="click->spot-metadata#clearMemoField"
          class="absolute right-0 top-1/2 -translate-y-1/2
                 w-6 h-6
                 rounded-full bg-slate-200/90 backdrop-blur
                 text-slate-700 hover:bg-slate-400
                 text-[12px] leading-none font-bold transition"
        >
          ×
        </button>
      </div>
    </div>

    <!-- 画像URL（任意） -->
    <div>
      <%= f.label :image_url, "画像URL（任意）",
            class: "block text-sm font-medium text-gray-700 mb-1" %>

      <div class="relative w-full">
        <%= f.url_field :image_url,
              placeholder: "サムネイル用の画像URLがあれば入力",
              class: "w-full rounded-lg border border-slate-300 bg-white px-3 py-2 pr-10 text-sm
                      shadow-inner focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500",
              data: {
                spot_metadata_target: "imageUrl",
                action: "input->spot-metadata#updateImagePreview"
              } %>

      <!-- 画像プレビュー -->
      <div
        data-spot-metadata-target="imagePreviewWrapper"
        class="mt-3 <%= 'hidden' if spot.image_url.blank? %>">
        <%= image_tag(
              spot.image_url.presence || "",
              class: "w-full max-h-60 object-cover rounded-lg border border-slate-200",
              data: { spot_metadata_target: "imagePreview" }
            ) %>

      <!-- プレビューのクリアボタン -->
        <button
          type="button"
          class="mt-2 inline-flex items-center px-3 py-1 rounded-md text-[11px]
                 border border-slate-300 bg-white text-slate-600
                 hover:bg-slate-100"
          data-action="click->spot-metadata#clearImage"
        >
          画像プレビューをクリア
        </button>
      </div>

    <!-- 行き先リスト選択 -->
    <div class="pt-3 border-t border-slate-100">
      <p class="text-xs font-medium text-gray-700 mb-1">
        どの「行き先リスト」に入れる？
      </p>

      <% if current_user.lists.any? %>
        <div class="max-h-40 sm:max-h-52 overflow-y-auto pr-1
                    bg-slate-50 rounded-lg p-2 border border-slate-200">
          <div class="flex flex-wrap gap-2">
            <%= f.collection_check_boxes :list_ids, current_user.lists, :id, :name do |b| %>
              <label class="inline-flex items-center gap-1 px-3 py-1 rounded-full
                            border border-slate-300 bg-white text-xs text-gray-700
                            hover:border-emerald-300 hover:bg-emerald-50 cursor-pointer">
                <%= b.check_box class: "rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" %>
                <span class="truncate max-w-[140px]"><%= b.text %></span>
              </label>
            <% end %>
          </div>
        </div>
      <% else %>
        <p class="text-xs text-gray-500">
          まだ行き先リストがありません。<br>
          先に <%= link_to "リストを作成", new_list_path,
                  class: "text-emerald-600 underline decoration-emerald-300" %> してから、
          スポットを登録しましょう。
        </p>
      <% end %>
    </div>

    <!-- タグ入力(tagging) -->
    <div
      data-controller="tag-input"
      data-tag-input-initial-tags-value="<%= spot.tag_names %>"
    >
      <p class="text-xs font-medium text-gray-700 mb-1">
        タグをつけておくと、あとで見返しやすくなります。<br>
        <span class="text-[11px] text-gray-500">
          スペース / 、 / カンマで区切って複数入力できます。<br>
          Enterでタグを追加します。
        </span>
      </p>

      <!-- チップを並べるエリア -->
      <div class="flex flex-wrap gap-2 mb-2" data-tag-input-target="chips"></div>

      <!-- 追加用インプット -->
      <input
        type="text"
        placeholder="例）デート 夜景 個室あり"
        class="w-full rounded-lg border border-dashed border-slate-300 bg-slate-50 px-3 py-2 text-xs text-gray-700
               focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
        data-tag-input-target="input"
        data-action="keydown->tag-input#handleKeydown blur->tag-input#commitInput"
      >

      <!-- 実際に送信する hidden フィールド -->
      <%= hidden_field_tag "spot[tag_names]",
            spot.tag_names,
            data: { tag_input_target: "hidden" } %>
    </div>

    <!-- ボタン -->
    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
      <% cancel_path =
            if request.referer.present?
              request.referer
            else
              spot.persisted? ? spot_path(spot) : spots_path
            end %>

      <%= link_to "キャンセル",
                  cancel_path,
                  class: "text-xs sm:text-sm text-gray-500 hover:text-gray-700" %>

      <div class="flex gap-2 items-center">
        <!-- 自動入力リセットボタン -->
        <button
          type="button"
          class="inline-flex items-center px-4 py-2 rounded-lg text-[11px] sm:text-xs
                 border border-slate-300 bg-white text-slate-600
                 hover:bg-slate-100"
          data-action="click->spot-metadata#clearAutoFilled"
        >
          自動入力をリセット
        </button>

        <%= f.submit "保存する",
              class: "inline-flex items-center px-4 py-2 rounded-lg text-xs sm:text-sm
                      bg-emerald-500 text-white font-medium hover:bg-emerald-600
                      disabled:opacity-60 disabled:cursor-not-allowed" %>
      </div>
    </div>
  <% end %>
</div>
